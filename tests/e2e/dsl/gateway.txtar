# SETUP: construct working folder layout
exec cp $REPODIR/tests/scripts/workflow.sh $WORKDIR/workflow.sh
exec cp -r . $WORKDIR
cd $WORKDIR

# TEST: operate the simulation
exec sh -e workflow.sh gateway.dse BUILD_ONLY
exec sh -e test.sh

stdout 'Channel: signal \(expected models=2\)'

stdout 'Platform OS: linux'
stdout 'Platform Arch: amd64'
stdout 'Using gateway symbols: ...'
stdout 'Unique signals identified: 1'
stdout 'Setup for async Simulation Model run ...'
stdout '\[0.004500\] signal\[0\] = 9.000000 \(counter\)'
stdout 'Call symbol: model_destroy ...'
stdout 'Controller exit ...'


-- gateway.dse --
simulation
channel signal

uses
dse.sdp https://github.com/boschglobal/dse.sdp v$RELEASE_VERSION

model gateway external=true
channel signal data

model simple Simple
channel signal data
file signalgroup.yaml signalgroup.yaml


-- gw.yaml --
---
kind: Stack
metadata:
  name: remote
spec:
  connection:
    transport:
      redis:
        uri: redis://localhost:6379
        timeout: 60
  models:
    - name: gateway
      uid: 42
      model:
        name: Gateway
      channels:
        - name: signal
          alias: signal
          selectors:
            channel: signal
---
kind: Model
metadata:
  name: Gateway
spec:
  runtime:
    gateway: {}
  channels:
    - alias: signal
      selectors:
        channel: signal
---
kind: SignalGroup
metadata:
  name: signal
  labels:
    channel: signal
spec:
  signals:
    - signal: counter


-- signalgroup.yaml --
---
kind: SignalGroup
metadata:
  name: data
  labels:
    model: simple
    signal: data
spec:
  signals:
    - signal: counter


-- test.sh --
DSE_SIMER_IMAGE="${DSE_SIMER_IMAGE:-ghcr.io/boschglobal/dse-simer:latest}"
export LD_LIBRARY_PATH=/repo/examples/models/build/_deps/dse_modelc_lib-src/examples/runtime/lib

docker run --name simer -i --rm \
    -v $ENTRYWORKDIR/out/sim:/sim \
    --network=host \
    "${DSE_SIMER_IMAGE}" \
        -env simbus:SIMBUS_LOGLEVEL=4 \
        -stack default \
        -timeout 5 &

/repo/examples/models/build/_out/gateway/bin/gateway 0.0005 0.005 gw.yaml
