# SETUP: construct working folder layout
exec cp $REPODIR/tests/scripts/workflow.sh $WORKDIR/workflow.sh
exec cp -r . $WORKDIR
cd $WORKDIR

# TEST: operate the simulation
exec sh -e workflow.sh gateway.dse BUILD_ONLY
exec sh -e test.sh

exists /workdir/out/downloads/Models-${RELEASE_VERSION}-linux-amd64.zip
exists /workdir/out/sim/model/gateway/bin/gateway
exists out/downloads/models/gateway/remote_foo.txt

stdout 'Channel: signal \(expected models=2\)'

stdout 'Platform OS: linux'
stdout 'Platform Arch: amd64'
stdout 'Using gateway symbols: ...'
stdout 'Unique signals identified: 1'
stdout 'Setup for async Simulation Model run ...'
stdout '\[0.004500\] signal\[0\] = 9.000000 \(counter\)'
stdout 'Call symbol: model_destroy ...'
stdout 'Controller exit ...'

-- gateway.dse --
simulation
channel signal

uses
dse.sdp https://github.com/boschglobal/dse.sdp v$RELEASE_VERSION
input https://raw.githubusercontent.com/boschglobal/dse.sdp/main/tests/testdata/e2e/remote_foo.txt

stack remote
model gateway Gateway external=true
channel signal data
file signalgroup.yaml signalgroup.yaml
workflow filedownload
var FILE uses input

model simple Simple
channel signal data
file signalgroup.yaml simple_signalgroup.yaml


-- signalgroup.yaml --
---
kind: SignalGroup
metadata:
  name: data
  labels:
    model: gateway
    signal: data
spec:
  signals:
    - signal: counter

-- simple_signalgroup.yaml --
---
kind: SignalGroup
metadata:
  name: data
  labels:
    model: simple
    signal: data
spec:
  signals:
    - signal: counter


-- test.sh --
DSE_SIMER_IMAGE="${DSE_SIMER_IMAGE:-ghcr.io/boschglobal/dse-simer:latest}"

docker run --name simer -i --rm \
    -v $ENTRYWORKDIR/out/sim:/sim \
    --network=host \
    "${DSE_SIMER_IMAGE}" \
        -env simbus:SIMBUS_LOGLEVEL=4 \
        -stack remote \
        -timeout 5 &

docker run --name gateway -i --rm \
    -v $ENTRYWORKDIR/out/sim:/sim \
    --env SIMBUS_LOGLEVEL=3 \
    --network=host \
    --entrypoint="" \
    "${DSE_SIMER_IMAGE}" \
        bash -c "valgrind -q --leak-check=yes --error-exitcode=808 model/gateway/bin/gateway 0.0005 0.005 data/simulation.yaml model/gateway/data/signalgroup.yaml model/gateway/data/model.yaml" &
