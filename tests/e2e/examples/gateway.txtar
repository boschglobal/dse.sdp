# SETUP: construct working folder layout
exec cp $REPODIR/tests/scripts/workflow.sh $WORKDIR/workflow.sh

env GW_DIR=$REPODIR/examples/models/gateway
exec cp $GW_DIR/model.yaml $WORKDIR/
exec cp $GW_DIR/signalgroup.yaml $WORKDIR/
exec cp $GW_DIR/simulation.yaml $WORKDIR/gw_simulation.yaml

env GW_EXAMPLE_DIR=$REPODIR/examples/gateway
exec cp $GW_EXAMPLE_DIR/gateway.dse $WORKDIR/
exec cp $GW_EXAMPLE_DIR/input.csv $WORKDIR/
exec cp $GW_EXAMPLE_DIR/input_signalgroup.yaml $WORKDIR/

exec cp -r . $WORKDIR
cd $WORKDIR

# TEST: operate the simulation
exec sh -e workflow.sh $WORKDIR/gateway.dse BUILD_ONLY
exec sh -e test.sh

stdout 'Platform OS: linux'
stdout 'Platform Arch: amd64'
stdout 'Channel: signal \(expected models=3\)'
stdout 'Unique signals identified: 4'

stdout 'Platform OS: linux'
stdout 'Platform Arch: amd64'
stdout 'Using gateway symbols: ...'
stdout 'Unique signals identified: 3'
stdout 'Setup for async Simulation Model run ...'
stdout '\[0.004500\] signal\[0\] = 1.300000 \(input\)'
stdout '\[0.004500\] signal\[1\] = 2.300000 \(factor\)'
stdout '\[0.004500\] signal\[2\] = -3.300000 \(offset\)'
stdout 'Call symbol: model_destroy ...'
stdout 'Controller exit ...'


-- test.sh --
DSE_SIMER_IMAGE="${DSE_SIMER_IMAGE:-ghcr.io/boschglobal/dse-simer:latest}"
export LD_LIBRARY_PATH=/repo/examples/models/build/_deps/dse_modelc_lib-src/examples/runtime/lib

docker run --name simer -i --rm \
    -v $ENTRYWORKDIR/out/sim:/sim \
    --network=host \
    "${DSE_SIMER_IMAGE}" \
        -env simbus:SIMBUS_LOGLEVEL=4 \
        -stack model \
        -timeout 5 &

/repo/examples/models/build/_out/gateway/bin/gateway 0.0005 0.005 gw_simulation.yaml signalgroup.yaml model.yaml
