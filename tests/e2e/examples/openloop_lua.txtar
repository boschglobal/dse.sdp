env DEBUG=0
env EXAMPLE_DSE=openloop.dse
env EXAMPLE_DIR=$REPODIR/examples/openloop_lua

# SETUP: construct working folder layout
exec cp $REPODIR/tests/scripts/workflow.sh $WORKDIR/workflow.sh
exec cp -r $EXAMPLE_DIR/. $WORKDIR
exec cp -r . $WORKDIR
cd $WORKDIR

# TEST: build the simulation
exec sh -c 'ls -lhR | awk "{print \$1, \$3, \$5, \$9}"'
exec sh -e workflow.sh $WORKDIR/$EXAMPLE_DSE BUILD_ONLY
exec sh -c 'if [ -n "$DEBUG" ]; then cd out/sim; ls -lhR | awk "{print \$1, \$3, \$5, \$9}"; fi'

exists out/sim/data/simulation.yaml
exists out/sim/model/input/csv.lua
exists out/sim/model/input/data/input.csv
exists out/sim/model/input/data/signalgroup.yaml
exists out/sim/model/linear/linear.lua
exists out/sim/model/linear/data/signalgroup.yaml

# TEST: run the simulation
exec sh -e workflow.sh $WORKDIR/$EXAMPLE_DSE SIMER_ONLY

stdout 'Lua MCL: loading model: model/linear/linear.lua'
stdout 'Linear model_create\(\)'
stdout 'Initial values: input=0.000000 factor=0.000000 offset=0.000000 output=0.000000'
stdout 'Linear model_destroy\(\)'
stdout 'Step@0.0000: input=0.000000 factor=0.000000 offset=0.000000 output=0.000000'
stdout 'Step@0.0025: input=1.300000 factor=2.300000 offset=-3.300000 output=-0.310000'
