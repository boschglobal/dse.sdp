env DEBUG=0
env EXAMPLE_DSE=openloop.dse
env EXAMPLE_DIR=$REPODIR/examples/openloop

# SETUP: construct working folder layout
exec cp $REPODIR/tests/scripts/workflow.sh $WORKDIR/workflow.sh
exec cp -r $EXAMPLE_DIR/. $WORKDIR
exec cp -r . $WORKDIR
cd $WORKDIR

# TEST: build the simulation
exec sh -c 'ls -lhR | awk "{print \$1, \$3, \$5, \$9}"'
exec sh -e workflow.sh $WORKDIR/$EXAMPLE_DSE BUILD_ONLY
exec sh -c 'if [ -n "$DEBUG" ]; then cd out/sim; ls -lhR | awk "{print \$1, \$3, \$5, \$9}"; fi'

exists out/sim/data/simulation.yaml
exists out/sim/model/input/lib/libcsv.so
exists out/sim/model/input/data/input.csv
exists out/sim/model/input/data/model.yaml
exists out/sim/model/input/data/signalgroup.yaml
exists out/sim/model/linear/lib/libfmimcl.so
exists out/sim/model/linear/linear_fmu/binaries/linux64/fmu2linear.so
exists out/sim/model/linear/data/model.yaml
exists out/sim/model/linear/data/signalgroup.yaml

# TEST: run reports
! exec sh -e workflow.sh $WORKDIR/$EXAMPLE_DSE REPORT_ONLY
stdout 'Ran 6 Reports | Passed: 5 | Failed: 1'
stdout '\[PASS\] ModelInstance Name Check'
stdout '\[PASS\] Model UID Check'
stdout '\[PASS\] Channel .expectedModelCount.'
stdout '\[PASS\] Count .ModelInst. in AST and SIM'
stdout '\[PASS\] Simbus Channel Name Consistency'
stdout '\[FAIL\] Duplicate Writes Check'

# TEST: run the simulation
exec sh -e workflow.sh $WORKDIR/$EXAMPLE_DSE SIMER_ONLY

stdout '\[0\] uid=1552937894, val=2.300000, final_val=2.300000, name=factor'
stdout '\[1\] uid=348705738, val=-3.300000, final_val=-3.300000, name=offset'
stdout '\[2\] uid=4191711099, val=1.300000, final_val=1.300000, name=input'
stdout '\[3\] uid=2041138948, val=-0.310000, final_val=-0.310000, name=output'
