

exec mkdir -p $WORK/.local/share/dse-graph
exec cp -r $ENTRYDIR/graph/cmd/graph/reports $WORK/.local/share/dse-graph/
env HOME=$WORK

env DSE_DIR=$REPODIR/examples/vscode

exec mkdir -p $WORK/input
exec cp -r $DSE_DIR/input/. $WORK/input
exec cp $DSE_DIR/openloop.dse $WORK/

exec sh -e $WORK/build.sh openloop.dse

stdout 'Parameters:'
stdout '  input_file = openloop.dse'
stdout '  output_file = openloop.json'
stdout 'Read from file: openloop.dse'
stdout 'Parsing ...'
stdout 'Writing to file: openloop.json'

stderr 'Running command: convert'
stderr '  input          : openloop.json'
stderr '  log            : 4'
stderr '  output         : openloop.yaml'
stderr 'Reading file: openloop.json'
stderr 'Writing file: openloop.yaml'

stderr 'Running command: resolve'
stderr '  cache          : out/cache'
stderr '  input          : openloop.yaml'
stderr 'INFO Reading AST file file=openloop.yaml'
stderr 'INFO Update metadata for repo name=dse.modelc'
stderr 'INFO Update metadata for repo name=dse.fmi'
stderr 'INFO Updating model metadata model=dse.modelc.csv name=input'
stderr 'INFO Repo metadata located repo=dse.modelc model=dse.modelc.csv'
stderr 'INFO Updating model uses model=dse.modelc.csv name=input'
stderr 'INFO Updating model metadata model=dse.fmi.mcl name=linear'
stderr 'INFO Repo metadata located repo=dse.fmi model=dse.fmi.mcl'
stderr 'INFO Task metadata located repo=dse.fmi taskName=generate-fmimcl'
stderr 'INFO Updating model uses model=dse.fmi.mcl name=linear'

stderr 'Running command: generate'
stderr '  input          : openloop.yaml'
stderr '  log            : 4'
stderr '  simulation     : false'
stderr '  taskfile       : false'
stderr 'Reading file: openloop.yaml'
stderr 'Writing to folder: .'
stderr 'Writing taskfile: Taskfile.yml'
stderr 'Writing simulation: simulation.yaml'

stdout 'SIM Model input -> sim/model/input'
stdout 'SIM Model linear -> sim/model/linear'
stderr 'task: "default" started'
stderr 'task: "build" started'
stderr 'task: "build-models" started'
stderr 'task: "model-input" started'
stderr 'task: "model-linear" started'
stderr 'task: "download-file" started'
stderr 'task: "download-file" finished'
stderr 'task: "model-input" finished'
stderr 'task: "dse.fmi-v[0-9]+\.[0-9]+\.[0-9]+:generate-fmimcl" started'
stderr 'task: "dse.fmi-v[0-9]+\.[0-9]+\.[0-9]+:gen-mcl" started'
stderr 'task: "dse.fmi-v[0-9]+\.[0-9]+\.[0-9]+:gen-mcl" finished'
stderr 'task: "dse.fmi-v[0-9]+\.[0-9]+\.[0-9]+:gen-signalgroup" started'
stderr 'task: "dse.fmi-v[0-9]+\.[0-9]+\.[0-9]+:gen-signalgroup" finished'
stderr 'task: "dse.fmi-v[0-9]+\.[0-9]+\.[0-9]+:generate-fmimcl" finished'
stderr 'task: "model-linear" finished'
stderr 'task: "build-models" finished'
stderr 'task: "build" finished'
stderr 'task: "default" finished'

exec sh -e $WORK/report.sh

stdout 'Name: Duplicate Writes Check'
stdout 'Query: Duplicate Write Signals'
stdout 'Evaluation: Report Passed'
stdout 'Name: ModelInstance Name Check'
stdout 'Query: Unique ModelInstance Name'
stdout 'Evaluation: Report Passed'
stdout 'Name: Model UID Check'
stdout 'Query: Unique Non-zero Model UID'
stdout 'Evaluation: Report Passed'
stdout 'Query: Expected Count'
stdout 'Evaluation: Report Passed'
stdout 'Query: Model to Channel Mapping'
stdout 'Query: Expected Count'
stdout 'Evaluation: Report Passed'
stdout 'Ran 5 Reports | Passed: 5 | Failed: 0'

exec sh -e $WORK/simer.sh

stdout 'Load YAML File: data/simulation\.yaml'
stdout 'Load YAML File: model/input/data/model.yaml'
stdout 'Loading symbol: model_create \.\.\. ok'
stdout 'Loading symbol: model_step \.\.\. ok'
stdout 'Loading symbol: model_destroy \.\.\. ok'
stdout 'Measurement File: /sim/measurement\.mf4'

-- build.sh --
INPUT_DSE="$1"
export TASK_X_REMOTE_TASKFILES=1
export DSE_BUILDER_IMAGE=ghcr.io/boschglobal/dse-builder:latest
docker run --rm \
    --network=host \
		-e AR_USER -e AR_TOKEN -e GHE_USER -e GHE_TOKEN -e GHE_PAT \
    -e http_proxy -e https_proxy -e no_proxy \
		-v $(pwd):/workdir \
    --user $(id -u):$(id -g) \
		"$DSE_BUILDER_IMAGE" "$INPUT_DSE"
task -y -v

-- report.sh --
export DSE_REPORT_IMAGE=ghcr.io/boschglobal/dse-report:latest
docker run --rm \
		-v $(pwd)/out/sim:/sim \
		"$DSE_REPORT_IMAGE" /sim

-- simer.sh --
export DSE_SIMER_IMAGE=ghcr.io/boschglobal/dse-simer:latest
docker run --rm \
  -v "$(pwd)/out/sim":/sim \
  -p 2159:2159 -p 6379:6379 \
  "$DSE_SIMER_IMAGE" \
  -redis="" \
  -simbus="" \
  -transport="loopback" \
  -uri="loopback" \
  -endtime 0.100 \
  -logger 4 \
  -env SIMBUS_LOGLEVEL=2