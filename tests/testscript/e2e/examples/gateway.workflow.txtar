exec cp $REPODIR/tests/testscript/scripts/workflow.sh $WORK/workflow.sh
exec sh -e $WORK/workflow.sh gateway.dse BUILD_ONLY

stdout 'Using gateway symbols: ...'
stdout 'Setup for async Simulation Model run ...'
stdout 'Call symbol: model_destroy ...'
stdout 'Controller exit ...'

stdout '[0.000000] binary[0] = <0:0>(null)'
stdout '\[0.000000\] binary\[0\] = <0:0>\(null\) \(scalar_foo\)'
stdout '\[0.000000\] binary\[1\] = <0:0>\(null\) \(scalar_bar\)'
stdout '\[0.000500\] binary\[0\] = <20:20>st=0.000000,index=0 \(scalar_foo\)'
stdout '\[0.000500\] binary\[1\] = <20:20>st=0.000000,index=1 \(scalar_bar\)'
stdout '\[0.000000\] scalar\[0\] = <0:0>\(null\) \(scalar_foo\)'
stdout '\[0.000000\] scalar\[1\] = <0:0>\(null\) \(scalar_bar\)'
stdout '\[0.000500\] scalar\[0\] = <20:20>st=0.000000,index=0 \(scalar_foo\)'
stdout '\[0.000500\] scalar\[1\] = <20:20>st=0.000000,index=1 \(scalar_bar\)'
stdout '\[0.002000\] binary\[0\] = <20:20>st=0.001500,index=0 \(scalar_foo\)'
stdout '\[0.002000\] binary\[1\] = <20:20>st=0.001500,index=1 \(scalar_bar\)'
stdout '\[0.002000\] binary\[2\] = <20:20>st=0.001500,index=2 \(binary_foo\)'
stdout '\[0.002000\] binary\[3\] = <20:20>st=0.001500,index=3 \(binary_bar\)'
stdout '\[0.002000\] scalar\[0\] = <20:20>st=0.001500,index=0 \(scalar_foo\)'
stdout '\[0.002000\] scalar\[1\] = <20:20>st=0.001500,index=1 \(scalar_bar\)'
stdout '\[0.002000\] scalar\[2\] = <20:20>st=0.001500,index=2 \(binary_foo\)'
stdout '\[0.002000\] scalar\[3\] = <20:20>st=0.001500,index=3 \(binary_bar\)'


-- gateway.dse --
simulation
channel binary
channel scalar

uses
dse.sdp https://github.com/boschglobal/dse.sdp v0.8.6

stack remote
model gateway Gateway external=true
channel scalar scalar_vector
channel binary binary_vector
file signalgroup.yaml signalgroup.yaml
workflow info


-- signalgroup.yaml --
---
kind: SignalGroup
metadata:
  name: test_scalar_signals
  labels:
    model: gateway
    channel: scalar
spec:
  signals:
    - signal: scalar_foo
    - signal: scalar_bar
---
kind: SignalGroup
metadata:
  name: test_binary_signals
  labels:
    model: gateway
    channel: binary
  annotations:
    vector_type: binary
    vector_name: network_vector
spec:
  signals:
    - signal: binary_foo
      annotations:
        name: binary_foo
    - signal: binary_bar
      annotations:
        name: binary_bar
        mime_type: application/custom-stream


-- test.sh --
export DSE_SIMER_IMAGE=ghcr.io/boschglobal/dse-simer:latest
export SIM_PATH="$(pwd)/out/sim"
docker run --name simer -d --rm \
		-v $(SIM_PATH)/model/gateway:/sim \
		--network=host \
		$(DSE_SIMER_IMAGE) \
			-env simbus:SIMBUS_LOGLEVEL=4 \
			-stack local \
			-timeout 5

docker run --name gateway -i --rm \
		-v $(SIM_PATH):/sim \
		--env SIMBUS_LOGLEVEL=3 \
		--network=host \
		--entrypoint="" \
		$(DSE_SIMER_IMAGE) \
			bash -c "valgrind -q --leak-check=yes --error-exitcode=808 model/gateway/bin/gateway 0.0005 0.0020 data/simulation.yaml model/gateway/data/signalgroup.yaml model/gateway/data/model.yaml" &

