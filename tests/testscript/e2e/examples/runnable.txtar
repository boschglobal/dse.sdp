exec mkdir -p $WORK/.local/share/dse-graph
exec cp -r $ENTRYDIR/graph/cmd/graph/reports $WORK/.local/share/dse-graph/
env HOME=$WORK

env DSE_DIR=$REPODIR/examples/runnable

exec cp $DSE_DIR/runnable.dse $WORK/

exec cp $REPODIR/tests/testscript/scripts/workflow.sh $WORK/workflow.sh
exec sh -e $WORK/workflow.sh runnable.dse

# dse-builder

stdout 'Parameters:'
stdout '  input_file = runnable.dse'
stdout '  output_file = runnable.json'
stdout 'Read from file: runnable.dse'
stdout 'Parsing ...'
stdout 'Writing to file: runnable.json'

stderr 'Running command: convert'
stderr '  input          : runnable.json'
stderr '  log            : 4'
stderr '  output         : runnable.yaml'
stderr 'Reading file: runnable.json'
stderr 'Writing file: runnable.yaml'

stderr 'Running command: resolve'
stderr '  cache          : out/cache'
stderr '  input          : runnable.yaml'
stderr 'INFO Reading AST file file=runnable.yaml'
stderr 'INFO Load metadata files'
stderr 'INFO Update metadata for repo name=fsil.runnable'
stderr 'INFO Update metadata for repo name=dse.fmi'
stderr 'INFO Updating AST file file=runnable.yaml'
stderr 'INFO Uses item name=dse.fmi'
stderr 'INFO Merge metadata to spec\/uses\[\] name=dse.fmi'
stderr 'Updating model metadata model=fsil.runnable name=runnable'
stderr 'INFO Repo metadata located repo=fsil.runnable model=fsil.runnable'
stderr 'INFO Task metadata located repo=fsil.runnable taskName=generate-runnable'
stderr 'INFO Updating model uses model=fsil.runnable name=runnable'

stderr 'Running command: generate'
stderr '  input          : runnable.yaml'
stderr '  log            : 4'
stderr '  simulation     : false'
stderr '  taskfile       : false'
stderr 'Reading file: runnable.yaml'
stderr 'Writing to folder: .'
stderr 'Writing taskfile: Taskfile.yml'
stderr 'Writing simulation: simulation.yaml'

stderr 'task: "dse.fmi-v1.1.34:gen-modelcfmu-annotations" finished'
stderr 'task: "dse.fmi-v1.1.34:gen-fmu" started'
stderr 'Running FMI Toolset command: gen-fmu'
stderr 'task: "dse.fmi-v1.1.34:gen-fmu" finished'
stderr 'task: "dse.fmi-v1.1.34:generate-fmimodelc" finished'
stderr 'task: "model-runnable" finished'
stderr 'task: "build-models" finished'
stderr 'task: "build" finished'
stderr 'task: "default" finished'

# dse-report

stdout 'Name: Duplicate Writes Check'
stdout 'Query: Duplicate Write Signals'
stdout 'Evaluation: Report Passed'
stdout 'Name: ModelInstance Name Check'
stdout 'Query: Unique ModelInstance Name'
stdout 'Evaluation: Report Passed'
stdout 'Name: Model UID Check'
stdout 'Query: Unique Non-zero Model UID'
stdout 'Evaluation: Report Passed'
stdout 'Query: Expected Count'
stdout 'Evaluation: Report Passed'
stdout 'Query: Model to Channel Mapping'
stdout 'Query: Expected Count'
stdout 'Evaluation: Report Passed'
stdout 'Ran 5 Reports | Passed: 5 | Failed: 0'

# dse-simer

stdout 'Load YAML File: data/simulation.yaml'
stdout 'Load YAML File: model/runnable/data/model.yaml'
stdout 'Load YAML File: model/runnable/data/target_runnable.yaml'
stdout 'Load YAML File: model/runnable/data/target_signalgroup.yaml'
stdout 'Load YAML File: model/runnable/data/target_signalgroup_blocks.yaml'
stdout 'Model Name: fsil.runnable'
stdout 'Model File: model/runnable/lib/runnable.so'
stdout 'Model Location: model/runnable/lib/runnable.so'
stdout 'Loading dynamic model: model/runnable/lib/runnable.so ...'
